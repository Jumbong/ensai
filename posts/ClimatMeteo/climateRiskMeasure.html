<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jumbong Junior">
<meta name="dcterms.date" content="2024-05-10">

<title>Menu - Climate Risk Measures</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../ensai.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Menu</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/junior-jumbong-258330211/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text">LinkedIn</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/Jumbong"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text">Github</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Climate Risk Measures</li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Ensai 3A</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/ValueAtRisk/ValueAtRisk.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statistiques des risques extrÃªmes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/MasteringFinancialData/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mastering Financial Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/obligation/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ModÃ¨les de Courbe de taux</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/MarketFinance/schiller.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CAPE Ratio</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Machine learning 3A</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/machineLearning3A/TP1_solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TP1: PCA-OLS, Ridge, Lasso</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/machineLearning3A/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TP: Examen</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/machineLearning3A/QCM.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">QCM surprise</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">climat</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/ClimateScenario/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">simple tool in R to analyze data : Graph representationExecution</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/ClimatMeteo/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DiffÃ©rence entre climat et mÃ©tÃ©o</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/NotionCle/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Notions clÃ©s pour comprendre le changement climatique</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#carbon-footprint" id="toc-carbon-footprint" class="nav-link" data-scroll-target="#carbon-footprint"><span class="header-section-number">2</span> Carbon Footprint</a>
  <ul class="collapse">
  <li><a href="#carbon-metrics" id="toc-carbon-metrics" class="nav-link" data-scroll-target="#carbon-metrics"><span class="header-section-number">2.1</span> Carbon metrics</a></li>
  <li><a href="#additivity-property-of-carbon-intensity" id="toc-additivity-property-of-carbon-intensity" class="nav-link" data-scroll-target="#additivity-property-of-carbon-intensity"><span class="header-section-number">2.2</span> Additivity property of carbon intensity</a></li>
  <li><a href="#be-aware-of-mixing-large-capitalization-and-small-capitalization-companies." id="toc-be-aware-of-mixing-large-capitalization-and-small-capitalization-companies." class="nav-link" data-scroll-target="#be-aware-of-mixing-large-capitalization-and-small-capitalization-companies."><span class="header-section-number">2.3</span> Be aware of mixing large capitalization and small capitalization companies.</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Climate Risk Measures</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Climate Risk</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jumbong Junior </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 10, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>This paper is for those who believe in the critical importance of sustainability and a future with low carbon emissions. Thatâs why I published it on Medium. I hope that it will be helpful to those who are interested in the integration of climate risk into traditional business models. When I was working on my final year project, I was looking for a way to integrate climate risk into asset allocation models. As I reviewed the literature, I read many articles.I think itâs important to understand climate risk metrics before making a complicated decision model.</p>
<p>When working with a portfolio of a n asset, The concern of investor is to determine the weight <span class="math inline">\(w=(w_1,...w_n)\)</span> of each asset in the portfolio. The investor wants to know how much invest in each asset. Answering this question is the same as determining what weight assign to each asset.</p>
<p>The traditional portfolio optimization responds to this question. It requires input data such as the vector of expected returns <span class="math inline">\((\mu_1,...,\mu_n)\)</span> of asset, the vector <span class="math inline">\(\sigma\)</span> of asset volatilities and the correlation matrix <span class="math inline">\(\rho\)</span> of asset returns. We can then compute the first and second moment of the stochastics portfolio return. In particular, the portfolio risk corresponds to the portfolio volatility <span class="math inline">\(\sigma(x)\)</span>. To be more precise, using the parameters <span class="math inline">\(\sigma\)</span> and <span class="math inline">\(\rho\)</span>, we can compute the portfolio covariance matrix <span class="math inline">\(\Sigma\)</span>, which is defined as follows: <span class="math inline">\(\Sigma_{ij} = \sigma_i \sigma_j \rho_{ij}\)</span>. The first moment is equal to the expected return of the portfolio <span class="math inline">\(\mu(x) = \sum_{i=1}^{n} w_i \mu_i\)</span> While the second is equal to the variance of the portfolio returns <span class="math inline">\(\sigma(x) = \sqrt{\sum_{i=1}^{n} \sum_{j=1}^{n} w_i w_j \Sigma_{ij}}\)</span>.</p>
<p>When introducing climate-related risk, we have to define another measure <span class="math inline">\(C(w_1,...w_n)\)</span> that assesses the risk of climate change. Let consider a climate metrics <span class="math inline">\(C_i\)</span> of associated with asset <span class="math inline">\(i\)</span>. The nature of the climate risk is then different from the volatility risk measure since the latter satisfy the sod additivity property : <span class="math display">\[\sigma(w) &lt;= \sum_{i=1}^{n} w_i \sigma_i\]</span></p>
<p>Even if <span class="math inline">\(C(w)\)</span> is a convex risk measure, it is an abuse of language, because there is no way to diversify the climate risk: <span class="math display">\[C(w) \not &lt; \sum_{i=1}^{n} w_i C_i\]</span></p>
<p>Therefore, <span class="math inline">\(C(w)\)</span> play more the rule of an expected loss than a risk measure. In this paper, we will present some climate risk measures. First, we will present carbon footprint and carbon intensity.</p>
</section>
<section id="carbon-footprint" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="carbon-footprint"><span class="header-section-number">2</span> Carbon Footprint</h2>
<p>Carbon footprint is an indicator of the amount of greenhouse gas(GHG) emissions caused by human activities. Greenhouse gases absorb and emit radiation energy emitted by the Earth once the sun has warmed its surface, causing the greenhouse effect. The most common greenhouse gases are carbon dioxide (CO2), methane (CH4), and nitrous oxide (N2O). Itâs important to remind that the greenhouse effect Was crucial for the development of human life on Earth. Without it, the average temperature of the Earth would be -18Â°C. With the greenhouse effect, the current temperature of Earthâs surface is about +15Â°C. However, the increase in greenhouse gas emissions due to human activities has led to an increase in the greenhouse effect, which has caused global warming.</p>
<p><strong>Carbon footprint is expressed in CO2 equivalent (CO<span class="math inline">\(_2\)</span>e)</strong>, which is a term for describing different GHGs in a common unit. In another word, a quantity of GHG is express as C0<span class="math inline">\(_2\)</span>e By multiplying the GHG amount by its global warming potential(GWP).The GWP of a gas is the amount of a gas that would cause the same amount of warming as a CO2 over a specific time period. For example, the IPCCâs <span class="math inline">\(4^{th}\)</span> assessment report has used the following rules : 1 kg of methane corresponds to 25 kg of CO_<span class="math inline">\(2\)</span> and 1 kg of nitrous oxide corresponds to 298 kg of CO<span class="math inline">\(_2\)</span>.</p>
<p>This indicator allows to properly compare companies in the same sector or have the same characteristics. If the size of companies are not the same, it is better to use normalize indicator like carbon intensity.</p>
<p>To provide a common measure That can be used by all companies and to limit bias. The Greenhouse gas protocol has defined three scopes of carbon emissions.</p>
<p>### The three scopes of carbon emissions</p>
<ul>
<li><p><strong>Scope 1</strong> refers to direct emissions from sources that are owned or controlled by the company. For example, we can mention emissions from combustion in owned or controlled boilers, furnaces, vehicles, and air conditioning systems.</p></li>
<li><p><strong>Scope 2</strong> denotes indirect emissions from the generation of purchased electricity, steam, heating, and cooling consumed by the company. For example, we can mention emissions from the generation of electricity purchased and used by the company.</p></li>
<li><p><strong>Scope 3</strong> includes all other indirect emissions that occur in a companyâs value chain. For example, we can mention emissions from the extraction and production of purchased materials and fuels, transport-related activities in vehicles not owned or controlled by the reporting entity, electricity-related activities not covered in Scope 2, outsourced activities, waste disposal, etc.</p></li>
</ul>
<p>In what follows, we distinguish these three carbon emission measures by introducing the notations CE1, CE2 and CE3. Moreover, they are generally expressed in tons of carbon dioxide equivalent or tCO<span class="math inline">\(_2\)</span>e. Now we have a tool to construt our carbon metrics</p>
<section id="carbon-metrics" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="carbon-metrics"><span class="header-section-number">2.1</span> Carbon metrics</h3>
<p>The carbon metrics that is generally used to compare entities or companies is the carbon Intensity. The carbon intensity of company i with respect to scope j is defined as the ratio of the carbon emissions of scope j to the activity of the company. The carbon intensity of company i with respect to scope j is defined as follows:</p>
<p><span class="math display">\[CI_{ij} = \frac{CE_{ij}}{Y_i}\]</span></p>
<p>where <span class="math inline">\(CE_{ij}\)</span> is the carbon emissions of company i with respect to scope j and <span class="math inline">\(Y_i\)</span> is the activity of company i. The carbon intensity of company i is then defined as the sum of the carbon intensity of each scope:</p>
<p>where Y is an indicator measuring the activity of the company. For example, it can be the revenue, the number of employees, the number of products sold, etc. To apply this, we will you the data of the company. The data below comes from Trucost reporting year 2019.</p>
<div id="7008f529" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>carbon_footprint <span class="op">=</span> pd.read_csv(<span class="st">'carbon_footprint.csv'</span>, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>carbon_footprint.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Company</th>
<th data-quarto-table-cell-role="th">Emission Scope 1</th>
<th data-quarto-table-cell-role="th">Emission Scope 2</th>
<th data-quarto-table-cell-role="th">Emission Scope 3</th>
<th data-quarto-table-cell-role="th">Revenue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Alphabet</td>
<td>74462.0</td>
<td>5116949</td>
<td>7166240</td>
<td>161857</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Amazon</td>
<td>5760000.0</td>
<td>5500000</td>
<td>20054722</td>
<td>280522</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Apple</td>
<td>50463.0</td>
<td>862127</td>
<td>27618943</td>
<td>260174</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>BP</td>
<td>49199999.0</td>
<td>5200000</td>
<td>103840194</td>
<td>276850</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Danone</td>
<td>722122.0</td>
<td>944877</td>
<td>28969780</td>
<td>28308</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>To compute the carbon intensity, we can first compute the carbon intensity for each scope and then sum them up.</p>
<div id="f81a22cf" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>carbon_footprint[<span class="st">'CE1'</span>] <span class="op">=</span> carbon_footprint[<span class="st">'Emission Scope 1'</span>] <span class="op">/</span> carbon_footprint[<span class="st">'Revenue'</span>]</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>carbon_footprint[<span class="st">'CE2'</span>] <span class="op">=</span> carbon_footprint[<span class="st">'Emission Scope 2'</span>] <span class="op">/</span> carbon_footprint[<span class="st">'Revenue'</span>]</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>carbon_footprint[<span class="st">'CE3'</span>] <span class="op">=</span> carbon_footprint[<span class="st">'Emission Scope 3'</span>] <span class="op">/</span> carbon_footprint[<span class="st">'Revenue'</span>]</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>carbon_footprint[<span class="st">'CI'</span>] <span class="op">=</span> carbon_footprint[<span class="st">'CE1'</span>] <span class="op">+</span> carbon_footprint[<span class="st">'CE2'</span>] <span class="op">+</span> carbon_footprint[<span class="st">'CE3'</span>]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>carbon_footprint.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Company</th>
<th data-quarto-table-cell-role="th">Emission Scope 1</th>
<th data-quarto-table-cell-role="th">Emission Scope 2</th>
<th data-quarto-table-cell-role="th">Emission Scope 3</th>
<th data-quarto-table-cell-role="th">Revenue</th>
<th data-quarto-table-cell-role="th">CE1</th>
<th data-quarto-table-cell-role="th">CE2</th>
<th data-quarto-table-cell-role="th">CE3</th>
<th data-quarto-table-cell-role="th">CI</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Alphabet</td>
<td>74462.0</td>
<td>5116949</td>
<td>7166240</td>
<td>161857</td>
<td>0.460048</td>
<td>31.614011</td>
<td>44.275132</td>
<td>76.349191</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Amazon</td>
<td>5760000.0</td>
<td>5500000</td>
<td>20054722</td>
<td>280522</td>
<td>20.533149</td>
<td>19.606305</td>
<td>71.490728</td>
<td>111.630182</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Apple</td>
<td>50463.0</td>
<td>862127</td>
<td>27618943</td>
<td>260174</td>
<td>0.193959</td>
<td>3.313655</td>
<td>106.155661</td>
<td>109.663275</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>BP</td>
<td>49199999.0</td>
<td>5200000</td>
<td>103840194</td>
<td>276850</td>
<td>177.713560</td>
<td>18.782734</td>
<td>375.077457</td>
<td>571.573751</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Danone</td>
<td>722122.0</td>
<td>944877</td>
<td>28969780</td>
<td>28308</td>
<td>25.509467</td>
<td>33.378444</td>
<td>1023.377844</td>
<td>1082.265755</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>One advantage of carbon intensity is that it reduces the skewness of the data.</p>
<div id="98dbd25a" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Skewness of the data</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>carbon_footprint[[<span class="st">'Emission Scope 1'</span>, <span class="st">'Emission Scope 2'</span>, <span class="st">'Emission Scope 3'</span>, <span class="st">'CI'</span>]].skew()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>Emission Scope 1    2.165456
Emission Scope 2    0.054302
Emission Scope 3    1.243665
CI                  1.559668
dtype: float64</code></pre>
</div>
</div>
<div id="15855241" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Skewness of the data</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>carbon_footprint[[<span class="st">'CE1'</span>, <span class="st">'CE2'</span>, <span class="st">'CE3'</span>, <span class="st">'CI'</span>]].skew()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>CE1    2.087192
CE2    0.813709
CE3    1.997709
CI     1.559668
dtype: float64</code></pre>
</div>
</div>
<p>Letâs now visualize the spearman correlation between the several carbon metrics.</p>
<div id="2f19400b" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>sns.heatmap(carbon_footprint[[<span class="st">'Emission Scope 1'</span>, <span class="st">'Emission Scope 2'</span>, <span class="st">'Emission Scope 3'</span>]].corr(), annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="climateRiskMeasure_files/figure-html/cell-6-output-1.png" width="727" height="490" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="eaacbb36" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>sns.heatmap(carbon_footprint[[<span class="st">'CE1'</span>, <span class="st">'CE2'</span>, <span class="st">'CE3'</span>]].corr(), annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="climateRiskMeasure_files/figure-html/cell-7-output-1.png" width="738" height="490" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We notice that carbon emissions are highly correlated that carbon intensity because of the economic size effect (<span class="math inline">\(33\%\)</span> in average vs <span class="math inline">\(23\%\)</span> in average). Now letâs visualize the rank correlation between the carbon metrics.</p>
<div id="1b770da7" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>sns.heatmap(carbon_footprint[[<span class="st">'Emission Scope 1'</span>, <span class="st">'Emission Scope 2'</span>, <span class="st">'Emission Scope 3'</span>]].corr(method<span class="op">=</span><span class="st">'spearman'</span>), annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="climateRiskMeasure_files/figure-html/cell-8-output-1.png" width="727" height="490" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="1403a5b8" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>sns.heatmap(carbon_footprint[[<span class="st">'CE1'</span>, <span class="st">'CE2'</span>, <span class="st">'CE3'</span>]].corr(method<span class="op">=</span><span class="st">'spearman'</span>), annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="climateRiskMeasure_files/figure-html/cell-9-output-1.png" width="727" height="490" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We notice that rank correlation between carbon emissions is higher than the rank correlation between carbon intensity, and rank correlation are very lower for all carbon intensity.</p>
<p>Letâs finish this section with the additivity property of carbon intensity.</p>
</section>
<section id="additivity-property-of-carbon-intensity" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="additivity-property-of-carbon-intensity"><span class="header-section-number">2.2</span> Additivity property of carbon intensity</h3>
<p>For a company i, the carbon intensity is additive. For example, the carbon intensity for a company i with respect to scope 1,2 and 3 is defined as follows: <span class="math display">\[
\begin{align}
    CL_{i,1+2+3} &amp;= \frac{CE_{i,1} + CE_{i,2} + CE_{i,3}}{Y_i} \\
                 &amp;= CI_{i,1} + CI_{i,2} + CI_{i,3}
\end{align}
\]</span></p>
<p>However, this property is not satisfied when we consider the carbon intensity of a portfolio of companies. Let us consider a portfolio of weights <span class="math inline">\(w=(w_1,...,w_n)\)</span> investing in n assets(stock, bond, etc). Its carbon emissions are defined as follows:</p>
<p><span class="math display">\[
CE_{j} = \sum_{i=1}^{n} \frac{W_i}{MV_i} CE_{ij} = \sum_{i=1}^{n} \bar{w_i} CE_{ij}
\]</span></p>
<p>where <span class="math inline">\(MV_i\)</span> is the market value the company i and j is the scope of carbon emissions, and <span class="math inline">\(W_i\)</span> is the dollar amount invested in company i. <span class="math inline">\(\bar{w_i}\)</span> is the ownership ratio:</p>
<p><span class="math display">\[
\bar{w_i} = \frac{W_i}{MV_i}
\]</span></p>
<p>If you invest <span class="math inline">\((x_1,...,x_n)\)</span> where <span class="math inline">\(x_i\)</span> is the dollar amount invested in company i, <span class="math inline">\(x=\sum_{i=1}^{n} x_i\)</span> is the total amount invested in the portfolio. We deduce that :</p>
<p><span class="math display">\[
\bar{w_i} = w_i \frac{x}{MV_i}
\]</span></p>
<p>and:</p>
<p><span class="math display">\[
\begin{align}
CE_{j} &amp;= \sum_{i=1}^{n} w_i \frac{x}{MV_i} CE_{ij} \\
&amp;= x \sum_{i=1}^{n} \frac{w_i}{MV_i} CE_{ij} \\
&amp;= x \sum_{i=1}^{n} \frac{w_i Y_i}{MV_i} \frac{CE_{ij}}{Y_i} \\
\end{align}
\]</span></p>
<p>This equation equation gives us an interpretation of the carbon emission as weighted average of the carbon intensity where the normalization is the market value of the company. In other words :</p>
<p><span class="math display">\[
CE_{j} = x \sum_{i=1}^{n} w_i CI_{ij}^{MV}
\]</span></p>
<p>where <span class="math inline">\(CI_{ij}^{MV} =\frac{CE_{ij}}{MV_i}\)</span> is the carbon intensity of company i with respect to scope j normalized by the market value of the company.</p>
</section>
<section id="be-aware-of-mixing-large-capitalization-and-small-capitalization-companies." class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="be-aware-of-mixing-large-capitalization-and-small-capitalization-companies."><span class="header-section-number">2.3</span> Be aware of mixing large capitalization and small capitalization companies.</h3>
<p>If we assume that the equation below is true:</p>
<p><span class="math display">\[
CE_{j} = \sum_{i=1}^{n} \frac{W_i}{MV_i} CE_{ij} = \sum_{i=1}^{n} \bar{w_i} CE_{ij}
\]</span></p>
<p>Then we can show that (refer to the page 8 and in appendix ix A.4.1 on page 45 on this book for more details):</p>
<p><span class="math display">\[
CI_{j}(w) = \sum_{i=1}^{n} x_i CI_{ij}
\]</span></p>
<p>where the weights <span class="math inline">\(x_i\)</span> are defined as follows:</p>
<p><span class="math inline">\(x_i = \frac{w_i\frac{Y_i}{MV_i}}{\sum_{i=1}^{n} w_i\frac{Y_i}{MV_i}} = \frac{w_i SR_i}{\sum_{i=1}^{n} w_i SR_i}\)</span></p>
<p>where <span class="math inline">\(SR_i = \frac{Y_i}{MV_i}\)</span> is the revenue-to-market value (or sales-to-price) ratio.</p>
<p>Now consider two issuers. The first issuer has a carbon emissions, revenue and market respectively equal to <span class="math inline">\(CE_{1,j} = 5 \times 10^6\)</span>, <span class="math inline">\(Y_1 = 2 \times 10^5\)</span> and <span class="math inline">\(MV_1 = 10^7\)</span>. The second issuer has a carbon emissions, revenue and market respectively equal to <span class="math inline">\(CE_{2,j} = 5 \times 10^7\)</span>, <span class="math inline">\(Y_2 = 4 \times 10^6\)</span> and <span class="math inline">\(MV_2 = 10^7\)</span>. We suppose we invest x=$10 mm to the issuers.</p>
<p>Letâs write utility classes to compute the carbon intensity of each issuer, the carbon emissions of the portfolio and the carbon intensity of the portfolio.</p>
<div id="c0e79bb8" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections.abc <span class="im">import</span> Iterable</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CarbonIntensity:</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> carbon_intensity_issuer(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        __CE: Iterable[<span class="bu">float</span>],</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        __Y: Iterable[<span class="bu">float</span>],</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> __CE <span class="op">/</span> __Y</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> revenue_to_market(</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        Y: Iterable[<span class="bu">float</span>],</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        MV: Iterable[<span class="bu">float</span>]</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Y <span class="op">/</span> MV</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> carbon_emission_portfolio(</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        x: Iterable[<span class="bu">float</span>],</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        CE: Iterable[<span class="bu">float</span>],</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        w: Iterable[<span class="bu">float</span>],</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        MV: Iterable[<span class="bu">float</span>]</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">sum</span>([x <span class="op">*</span> w <span class="op">*</span> CE <span class="op">/</span> MV <span class="cf">for</span> x, w, CE, MV <span class="kw">in</span> <span class="bu">zip</span>(x, w, CE, MV)])</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> carbon_intensity_portfolio(</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        w: Iterable[<span class="bu">float</span>],</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        Y: Iterable[<span class="bu">float</span>],</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        MV: Iterable[<span class="bu">float</span>],</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        CI: Iterable[<span class="bu">float</span>]</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        total_revenue_tomarket <span class="op">=</span> <span class="bu">sum</span>([(w <span class="op">*</span> Y) <span class="op">/</span> (MV) <span class="cf">for</span> w, Y, MV <span class="kw">in</span> <span class="bu">zip</span>(w, Y, MV)])</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">sum</span>([(w<span class="op">*</span>Y<span class="op">*</span>CI)<span class="op">/</span>(total_revenue_tomarket<span class="op">*</span> MV) <span class="cf">for</span> w, Y, CI, MV <span class="kw">in</span> <span class="bu">zip</span>(w, Y, CI, MV)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It follows that the carbon intensity of the first issuer is equal to 25 and the carbon intensity of the second issuer is equal to 12.5. It is given by the following code:</p>
<div id="e9586980" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>CE1, CE2 <span class="op">=</span> <span class="fl">5e6</span>, <span class="fl">5e7</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>Y1, Y2 <span class="op">=</span> <span class="fl">2e5</span>, <span class="fl">4e6</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>CarbonIntensity.carbon_intensity_issuer(CE1, Y1), CarbonIntensity.carbon_intensity_issuer(CE2, Y2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>(25.0, 12.5)</code></pre>
</div>
</div>
<p>The revenue-to-market ratio of the first issuer is equal to 0.02 and the revenue-to-market ratio of the second issuer is equal to 0.4. It is given by the following code:</p>
<div id="ef903726" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>MV1, MV2 <span class="op">=</span> <span class="fl">1e7</span>, <span class="fl">1e7</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>CarbonIntensity.revenue_to_market(Y1, MV1), CarbonIntensity.revenue_to_market(Y2, MV2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>(0.02, 0.4)</code></pre>
</div>
</div>
<p>Now, letâs compute the carbon emissions of the portfolio and the carbon intensity of the portfolio. If the weights of the first issuer is <span class="math inline">\(w_1\)</span> and the weights of the second issuer is <span class="math inline">\(w_2\)</span>, The revenue that will be use to compute the carbon intensity of the portfolio is equal: <span class="math inline">\(Y = w_1 \times Y_1 + w_2 \times Y_2\)</span> The weights <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> are given by the following code:</p>
<div id="90cfe88d" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'w1'</span>: [<span class="st">"0%"</span>, <span class="st">"10%"</span>, <span class="st">"20%"</span>, <span class="st">"30%"</span>, <span class="st">"50%"</span>, <span class="st">"70%"</span>, <span class="st">"80%"</span>, <span class="st">"90%"</span>, <span class="st">"100%"</span>],</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'w2'</span>: [<span class="st">"100%"</span>, <span class="st">"90%"</span>, <span class="st">"80%"</span>, <span class="st">"70%"</span>, <span class="st">"50%"</span>, <span class="st">"30%"</span>, <span class="st">"20%"</span>, <span class="st">"10%"</span>, <span class="st">"0%"</span>]}</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>weights[<span class="st">'w1'</span>] <span class="op">=</span> [<span class="bu">float</span>(w.replace(<span class="st">'%'</span>, <span class="st">''</span>)) <span class="op">/</span> <span class="dv">100</span> <span class="cf">for</span> w <span class="kw">in</span> weights[<span class="st">'w1'</span>]]</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>weights[<span class="st">'w2'</span>] <span class="op">=</span> [<span class="bu">float</span>(w.replace(<span class="st">'%'</span>, <span class="st">''</span>)) <span class="op">/</span> <span class="dv">100</span> <span class="cf">for</span> w <span class="kw">in</span> weights[<span class="st">'w2'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First we Compute the revenue to compute the carbon intensity of the portfolio :</p>
<div id="2ac47125" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>carbon_intensity_portfolio_approach <span class="op">=</span> pd.DataFrame()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>carbon_intensity_portfolio_approach[<span class="st">'w1'</span>] <span class="op">=</span> weights[<span class="st">'w1'</span>]</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>carbon_intensity_portfolio_approach[<span class="st">'w2'</span>] <span class="op">=</span> weights[<span class="st">'w2'</span>]</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>carbon_intensity_portfolio_approach[<span class="st">'Y *10^6'</span>] <span class="op">=</span> carbon_intensity_portfolio_approach[<span class="st">'w1'</span>] <span class="op">*</span> Y1<span class="op">/</span><span class="fl">1e6</span> <span class="op">+</span> carbon_intensity_portfolio_approach[<span class="st">'w2'</span>] <span class="op">*</span> Y2<span class="op">/</span><span class="fl">1e6</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>carbon_intensity_portfolio_approach</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">w1</th>
<th data-quarto-table-cell-role="th">w2</th>
<th data-quarto-table-cell-role="th">Y *10^6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.0</td>
<td>1.0</td>
<td>4.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.1</td>
<td>0.9</td>
<td>3.62</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.2</td>
<td>0.8</td>
<td>3.24</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.3</td>
<td>0.7</td>
<td>2.86</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.5</td>
<td>0.5</td>
<td>2.10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0.7</td>
<td>0.3</td>
<td>1.34</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0.8</td>
<td>0.2</td>
<td>0.96</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>0.9</td>
<td>0.1</td>
<td>0.58</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>1.0</td>
<td>0.0</td>
<td>0.20</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Then we compute the carbon emissions of the portfolio and the carbon intensity of the portfolio:</p>
<div id="b25a0e6b" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>carbon_intensity_portfolio_approach[<span class="st">'CE*10^6'</span>] <span class="op">=</span> CarbonIntensity.carbon_emission_portfolio(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>[<span class="fl">10e6</span>, <span class="fl">10e6</span>],</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    CE<span class="op">=</span>[CE1, CE2],</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    w<span class="op">=</span>[carbon_intensity_portfolio_approach[<span class="st">'w1'</span>], carbon_intensity_portfolio_approach[<span class="st">'w2'</span>]],</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    MV<span class="op">=</span>[MV1, MV2]</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>)<span class="op">/</span><span class="fl">1e6</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>carbon_intensity_portfolio_approach</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">w1</th>
<th data-quarto-table-cell-role="th">w2</th>
<th data-quarto-table-cell-role="th">Y *10^6</th>
<th data-quarto-table-cell-role="th">CE*10^6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.0</td>
<td>1.0</td>
<td>4.00</td>
<td>50.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.1</td>
<td>0.9</td>
<td>3.62</td>
<td>45.5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.2</td>
<td>0.8</td>
<td>3.24</td>
<td>41.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.3</td>
<td>0.7</td>
<td>2.86</td>
<td>36.5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.5</td>
<td>0.5</td>
<td>2.10</td>
<td>27.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0.7</td>
<td>0.3</td>
<td>1.34</td>
<td>18.5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0.8</td>
<td>0.2</td>
<td>0.96</td>
<td>14.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>0.9</td>
<td>0.1</td>
<td>0.58</td>
<td>9.5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>1.0</td>
<td>0.0</td>
<td>0.20</td>
<td>5.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Then we compute the carbon intensity of the portfolio. To do this, we need the carbon emissions of the portfolio and the revenue of the portfolio. The carbon intensity of the portfolio is given by the following code:</p>
<div id="b9d6dba5" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>carbon_intensity_portfolio_approach[<span class="st">'CI/Y'</span>] <span class="op">=</span> carbon_intensity_portfolio_approach[<span class="st">'CE*10^6'</span>] <span class="op">/</span> carbon_intensity_portfolio_approach[<span class="st">'Y *10^6'</span>]</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>carbon_intensity_portfolio_approach </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">w1</th>
<th data-quarto-table-cell-role="th">w2</th>
<th data-quarto-table-cell-role="th">Y *10^6</th>
<th data-quarto-table-cell-role="th">CE*10^6</th>
<th data-quarto-table-cell-role="th">CI/Y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.0</td>
<td>1.0</td>
<td>4.00</td>
<td>50.0</td>
<td>12.500000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.1</td>
<td>0.9</td>
<td>3.62</td>
<td>45.5</td>
<td>12.569061</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.2</td>
<td>0.8</td>
<td>3.24</td>
<td>41.0</td>
<td>12.654321</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.3</td>
<td>0.7</td>
<td>2.86</td>
<td>36.5</td>
<td>12.762238</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.5</td>
<td>0.5</td>
<td>2.10</td>
<td>27.5</td>
<td>13.095238</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0.7</td>
<td>0.3</td>
<td>1.34</td>
<td>18.5</td>
<td>13.805970</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0.8</td>
<td>0.2</td>
<td>0.96</td>
<td>14.0</td>
<td>14.583333</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>0.9</td>
<td>0.1</td>
<td>0.58</td>
<td>9.5</td>
<td>16.379310</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>1.0</td>
<td>0.0</td>
<td>0.20</td>
<td>5.0</td>
<td>25.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>we finish this section by computing the carbon intensity of the portfolio using the weights defined by: <span class="math inline">\(x_i = \frac{w_i\frac{Y_i}{MV_i}}{\sum_{i=1}^{n} w_i\frac{Y_i}{MV_i}} = \frac{w_i SR_i}{\sum_{i=1}^{n} w_i SR_i}\)</span></p>
<p>carbon_intensity_portfolio_approach[âCIâ] = CarbonIntensity.carbon_intensity_portfolio( w=[carbon_intensity_portfolio_approach[âw1â], carbon_intensity_portfolio_approach[âw2â]], Y=[Y1, Y2], MV=[MV1, MV2], CI=[CarbonIntensity.carbon_intensity_issuer(CE1, Y1), CarbonIntensity.carbon_intensity_issuer(CE2, Y2)] ) carbon_intensity_portfolio_approach</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>